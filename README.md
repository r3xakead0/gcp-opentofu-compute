# GCP OpenTofu Compute

Small GCP web stack delivered with OpenTofu and Terragrunt. Each environment (dev/qa/prod) provisions a VPC, subnetwork, firewall (SSH/HTTP), and a Debian 13 compute instance that installs NGINX and serves a sample page.

## Requirements
- OpenTofu `>= 1.10.0`
- Terragrunt `>= 0.95.0`
- `gcloud` CLI with ADC (`gcloud auth application-default login`) or `GOOGLE_APPLICATION_CREDENTIALS` service account key
- GCP project with billing enabled
- GCS bucket for remote state
- Permissions: can create network + compute resources and write to the state bucket

## Repo Layout
- `modules/` — reusable network and compute modules
- `environments/{dev,qa,prod}/terragrunt.hcl` — environment-specific inputs that call the root stack
- `terragrunt.hcl` — shared remote state + common inputs (project_id)
- Root `main.tf` — wires modules together; backend is generated by Terragrunt

## Configure Credentials & Variables
Set required environment variables (direnv-friendly):
```bash
export GCP_PROJECT_ID="<project>"
export GCS_BUCKET="<state-bucket>"
# Optional: namespace for state objects (defaults to "terragrunt")
export TG_STATE_PREFIX="<repo>/opentofu"
```

Authenticate:
```bash
gcloud auth application-default login
# or set GOOGLE_APPLICATION_CREDENTIALS to a service account key file
```

## Create the State Bucket (once)
```bash
gsutil mb -p "$GCP_PROJECT_ID" gs://$GCS_BUCKET
```

## Per-Environment Settings (defaults)
- `dev`: region `us-central1`, zone `us-central1-a`, CIDR `10.10.0.0/24`, machine `e2-micro`
- `qa`: region `us-central1`, zone `us-central1-b`, CIDR `10.20.0.0/24`, machine `e2-small`
- `prod`: region `us-central1`, zone `us-central1-c`, CIDR `10.30.0.0/24`, machine `e2-medium`
Override by editing the environment `terragrunt.hcl` or passing `-var`/`-var-file`.

## Usage (Terragrunt + OpenTofu)
Run from the environment directory you want:
```bash
cd environments/dev   # or qa / prod
terragrunt plan --tf-path tofu
terragrunt apply --tf-path tofu -auto-approve
terragrunt destroy --tf-path tofu -auto-approve
```

Read outputs (e.g., public IP):
```bash
terragrunt output --tf-path tofu instance_external_ip
```

## CI/CD (GitHub Actions)
- Deploy: `.github/workflows/deploy.yml` runs Terragrunt plan on PRs and apply on `main` for all environments (matrix).
- Destroy: `.github/workflows/destroy.yml` requires `DESTROY` confirmation and destroys dev/qa/prod in one run.

Required GitHub configuration:
- Secrets: `GCP_WIF_PROVIDER`, `GCP_SA_EMAIL`
- Vars: `GCP_PROJECT_ID`, `GCP_GCS_BUCKET`

## What Gets Deployed
- VPC and subnetwork named per environment
- Firewall allowing TCP 22/80 from `firewall_sources`, targeting `network_tags`
- Debian 13 compute instance with NGINX installed via startup script and public IP for HTTP/SSH
